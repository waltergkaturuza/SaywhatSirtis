// SIRTIS Database Schema - Supabase PostgreSQL Version
// SAYWHAT Integrated Real-Time Information System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =============================================
// USER MANAGEMENT & AUTHENTICATION
// =============================================

model User {
  id                String              @id @default(cuid())
  email             String              @unique
  username          String?             @unique
  firstName         String?
  lastName          String?
  role              UserRole            @default(USER)
  roles             String[]            @default([])
  department        String?
  position          String?
  isActive          Boolean             @default(true)
  lastLogin         DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  // Profile Information
  phoneNumber       String?
  profileImage      String?
  bio               String?
  location          String?
  
  // Security
  emailVerified     DateTime?
  twoFactorEnabled  Boolean             @default(false)
  
  // Relationships
  accounts          Account[]
  sessions          Session[]
  auditLogs         AuditLog[]
  createdProjects   Project[]           @relation("ProjectCreator")
  managedProjects   Project[]           @relation("ProjectManager")
  
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verificationtokens")
}

// =============================================
// AUDIT & LOGGING
// =============================================

model AuditLog {
  id          String   @id @default(cuid())
  userId      String?
  action      String
  resource    String
  resourceId  String?
  details     Json?
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime @default(now())
  
  user        User?    @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([timestamp])
  @@map("audit_logs")
}

// =============================================
// PROGRAMS MANAGEMENT
// =============================================

model Project {
  id              String    @id @default(cuid())
  name            String
  description     String?
  objectives      Json?
  timeframe       String?
  startDate       DateTime?
  endDate         DateTime?
  country         String?
  province        String?
  budget          Float?
  actualSpent     Float?    @default(0)
  status          String    @default("PLANNING")
  priority        String    @default("MEDIUM")
  progress        Int?      @default(0)
  managerId       String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  currency        String?   @default("USD")
  creatorId       String?
  
  // Relationships - match the actual database
  documents          Document[]
  activities         Activity[]
  manager            User?     @relation("ProjectManager", fields: [managerId], references: [id])
  creator            User?     @relation("ProjectCreator", fields: [creatorId], references: [id])
  
  @@index([status])
  @@map("projects")
}

model Activity {
  id          String    @id @default(cuid())
  title       String
  description String?   @db.Text
  status      String    @default("pending")
  dueDate     DateTime?
  completedAt DateTime?
  projectId   String
  
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([status])
  @@index([dueDate])
  @@index([projectId])
  @@map("activities")
}

// =============================================
// CALL CENTRE MANAGEMENT
// =============================================

model CallRecord {
  id              String    @id @default(cuid())
  caseNumber      String    @unique
  callerName      String
  callerPhone     String?
  callerEmail     String?
  callType        String?   @default("INBOUND")  // Changed from enum to String
  category        String?   @default("INQUIRY")  // Changed from enum to String
  priority        String?   @default("MEDIUM")   // Changed from enum to String
  status          String?   @default("OPEN")     // Changed from enum to String
  subject         String    // Added missing field
  description     String?   // Added missing field
  assignedOfficer String?
  
  // Call Details
  summary         String?   @db.Text
  notes           String?   @db.Text
  resolution      String?   @db.Text
  satisfactionRating Int?
  
  // Timestamps
  callStartTime   DateTime?
  callEndTime     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  resolvedAt      DateTime?
  
  // Location
  district        String?
  ward            String?
  
  // Follow-up
  followUpRequired Boolean  @default(false)
  followUpDate    DateTime?
  
  @@index([caseNumber])
  @@index([status])
  @@index([category])
  @@index([priority])
  @@index([assignedOfficer])
  @@index([callStartTime])
  @@map("call_records")
}

// =============================================
// HR MANAGEMENT
// =============================================

model Employee {
  id              String    @id @default(cuid())
  userId          String    @unique
  employeeId      String    @unique
  firstName       String
  lastName        String
  middleName      String?
  dateOfBirth     DateTime?
  gender          String?
  nationality     String?
  nationalId      String?   @unique
  passportNumber  String?
  email           String    @unique
  phoneNumber     String?   // This was renamed from 'phone' in migration
  alternativePhone String?
  address         String?
  emergencyContact String?
  emergencyPhone  String?
  department      String?
  position        String
  employmentType  String    @default("FULL_TIME")  // Converted from enum to String
  startDate       DateTime  // This is the original field
  hireDate        DateTime? // This was added in migration, copied from startDate
  endDate         DateTime?
  salary          Float?
  currency        String?   @default("USD")
  status          String    @default("ACTIVE")  // Converted from enum to String
  
  // HR Records
  performanceReviews PerformanceReview[]
  
  // Training Records
  trainingEnrollments TrainingEnrollment[]
  trainingAttendance  TrainingAttendance[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([employeeId])
  @@index([department])
  @@index([status])
  @@index([email])
  @@map("employees")
}

model PerformanceReview {
  id            String    @id @default(cuid())
  employeeId    String
  reviewPeriod  String    // "Q1 2024", "Annual 2024", etc.
  reviewType    String    // "quarterly", "annual", "probationary"
  overallRating Float?
  goals         Json?     // Array of goals and achievements
  feedback      String?   @db.Text
  reviewDate    DateTime
  nextReviewDate DateTime?
  
  employee      Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([employeeId])
  @@index([reviewDate])
  @@map("performance_reviews")
}

// =============================================
// TRAINING MANAGEMENT
// =============================================

model TrainingProgram {
  id              String    @id @default(cuid())
  title           String
  description     String?   @db.Text
  category        String    // "Technical", "Soft Skills", "Compliance", etc.
  duration        String    // "1 week", "3 days", "2 hours", etc.
  format          String    // "Online", "In-Person", "Hybrid"
  capacity        Int?
  instructor      String?
  status          String    @default("DRAFT") // "DRAFT", "PUBLISHED", "ACTIVE", "COMPLETED", "CANCELLED"
  startDate       DateTime?
  endDate         DateTime?
  enrollmentDeadline DateTime?
  certificationAvailable Boolean @default(false)
  prerequisites   String?   @db.Text
  learningObjectives Json?  // Array of objectives
  materials       Json?     // Array of materials/resources
  cost            Float?    @default(0)
  currency        String?   @default("USD")
  location        String?   // For in-person training
  onlineLink      String?   // For online training
  
  // Relationships
  enrollments     TrainingEnrollment[]
  sessions        TrainingSession[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([category])
  @@index([status])
  @@index([startDate])
  @@map("training_programs")
}

model TrainingEnrollment {
  id                String           @id @default(cuid())
  programId         String
  employeeId        String
  enrollmentDate    DateTime         @default(now())
  status            String           @default("ENROLLED") // "ENROLLED", "IN_PROGRESS", "COMPLETED", "DROPPED", "FAILED"
  progress          Int              @default(0) // Percentage
  completionDate    DateTime?
  finalScore        Float?
  feedback          String?          @db.Text
  attendanceRate    Float?           // Percentage
  
  // Relationships
  program           TrainingProgram  @relation(fields: [programId], references: [id], onDelete: Cascade)
  employee          Employee         @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  certificate       TrainingCertificate?
  
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  @@unique([programId, employeeId])
  @@index([employeeId])
  @@index([status])
  @@map("training_enrollments")
}

model TrainingSession {
  id              String          @id @default(cuid())
  programId       String
  title           String
  description     String?         @db.Text
  sessionDate     DateTime
  startTime       String          // "09:00"
  endTime         String          // "17:00"
  instructor      String?
  location        String?
  onlineLink      String?
  materials       Json?           // Session-specific materials
  maxAttendees    Int?
  
  // Relationships
  program         TrainingProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  attendance      TrainingAttendance[]
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([programId])
  @@index([sessionDate])
  @@map("training_sessions")
}

model TrainingAttendance {
  id              String          @id @default(cuid())
  sessionId       String
  employeeId      String
  status          String          // "PRESENT", "ABSENT", "LATE", "EXCUSED"
  checkInTime     DateTime?
  checkOutTime    DateTime?
  notes           String?
  
  // Relationships
  session         TrainingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  employee        Employee        @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@unique([sessionId, employeeId])
  @@index([employeeId])
  @@map("training_attendance")
}

model TrainingCertificate {
  id              String               @id @default(cuid())
  enrollmentId    String               @unique
  certificateNumber String             @unique
  issuedDate      DateTime
  expiryDate      DateTime?
  isValid         Boolean              @default(true)
  downloadCount   Int                  @default(0)
  
  // Relationships
  enrollment      TrainingEnrollment   @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  
  @@index([certificateNumber])
  @@index([issuedDate])
  @@map("training_certificates")
}

// =============================================
// INVENTORY MANAGEMENT
// =============================================

model Asset {
  id              String    @id @default(cuid())
  assetTag        String    @unique
  name            String
  description     String?   @db.Text
  category        String    // Match database: "Computer", "Equipment", etc.
  brand           String?   // Match database field name
  model           String?
  serialNumber    String?
  purchaseDate    DateTime?
  purchasePrice   Float?
  currentValue    Float?
  location        String?
  condition       AssetCondition @default(GOOD) // Enum for asset condition
  status          String    @default("ACTIVE")  // Match database: "ACTIVE", "maintenance", "disposed"
  warrantyExpiry  DateTime?
  
  // Records
  maintenanceRecords MaintenanceRecord[]
  auditRecords    AssetAudit[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([assetTag])
  @@index([category])
  @@index([status])
  @@index([location])
  @@map("assets")
}

model MaintenanceRecord {
  id              String    @id @default(cuid())
  assetId         String
  maintenanceType String    // "preventive", "corrective", "emergency"
  description     String?   @db.Text
  cost            Float?
  performedBy     String?
  performedDate   DateTime
  nextDueDate     DateTime?
  
  asset           Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([assetId])
  @@index([performedDate])
  @@map("maintenance_records")
}

model AssetAudit {
  id              String    @id @default(cuid())
  assetId         String
  auditDate       DateTime
  condition       String    // "excellent", "good", "fair", "poor"
  notes           String?   @db.Text
  auditedBy       String?
  
  asset           Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([assetId])
  @@index([auditDate])
  @@map("asset_audits")
}

// =============================================
// DOCUMENT MANAGEMENT
// =============================================

model Document {
  id              String    @id @default(cuid())
  filename        String
  originalName    String
  mimeType        String
  size            Int
  path            String    // File storage path
  url             String?   // Public URL if applicable
  category        DocumentCategory? // "policy", "report", "form", etc.
  tags            String[]  @default([])
  
  // AI Search Integration
  extractedText   String?   @db.Text
  summary         String?   @db.Text
  searchKeywords  String[]  @default([])
  
  // Access Control
  isPublic        Boolean   @default(false)
  accessLevel     String    @default("internal") // "public", "internal", "restricted"
  
  // Metadata
  uploadedBy      String?
  version         String    @default("1.0")
  description     String?   @db.Text
  projectId       String?
  
  // Relationships
  project         Project?  @relation(fields: [projectId], references: [id])
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([category])
  @@index([uploadedBy])
  @@index([isPublic])
  @@map("documents")
}

// =============================================
// EVENTS MANAGEMENT
// =============================================

model Event {
  id              String    @id @default(cuid())
  title           String
  description     String?   @db.Text
  type            String    // "flagship", "training", "meeting", etc.
  status          String    @default("planning") // "planning", "approved", "in-progress", "completed", "cancelled"
  startDate       DateTime
  endDate         DateTime?
  location        String?
  venue           String?
  capacity        Int?
  
  // Event Details
  agenda          Json?     // Event agenda/program
  speakers        Json?     // Speaker information
  budget          Float?
  actualCost      Float     @default(0)
  
  // Registration
  requiresRegistration Boolean @default(false)
  registrationDeadline DateTime?
  registrations   EventRegistration[]
  
  // Implementation Partners
  partners        Json?     // Implementation partners data
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([type])
  @@index([status])
  @@index([startDate])
  @@map("events")
}

model EventRegistration {
  id              String    @id @default(cuid())
  eventId         String
  participantName String
  participantEmail String
  participantPhone String?
  organization    String?
  position        String?
  specialRequirements String? @db.Text
  status          String    @default("pending") // "pending", "confirmed", "cancelled"
  
  event           Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  registeredAt    DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@unique([eventId, participantEmail])
  @@index([eventId])
  @@index([status])
  @@map("event_registrations")
}

// =============================================
// SYSTEM CONFIGURATION
// =============================================

model SystemConfig {
  id              String    @id @default(cuid())
  key             String    @unique
  value           Json
  description     String?
  category        String?   // "general", "security", "integrations"
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([category])
  @@map("system_config")
}

// =============================================
// NOTIFICATIONS
// =============================================

model Notification {
  id              String    @id @default(cuid())
  userId          String?
  type            NotificationType @default(INFO) // "info", "warning", "error", "success"
  title           String
  message         String    @db.Text
  isRead          Boolean   @default(false)
  actionUrl       String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// =============================================
// ENUMS
// =============================================

enum UserRole {
  SUPER_ADMIN
  ADMIN
  HR_MANAGER
  PROJECT_MANAGER
  CALL_CENTRE_AGENT
  EMPLOYEE
  USER
}

enum AuditLogSeverity {
  LOW
  INFO
  WARNING
  ERROR
  CRITICAL
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ProjectPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ActivityStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum CallType {
  INQUIRY
  COMPLAINT
  REQUEST
  EMERGENCY
  FEEDBACK
  OTHER
}

enum CallDirection {
  INBOUND
  OUTBOUND
}

enum AssetCondition {
  EXCELLENT
  GOOD
  FAIR
  POOR
  DAMAGED
}

enum CallPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum CallStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
  ESCALATED
  SPAM
}

enum DocumentCategory {
  PROJECT
  HR
  FINANCE
  LEGAL
  TRAINING
  POLICY
  REPORT
  OTHER
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  TERMINATED
  ON_LEAVE
}

enum AssetCategory {
  COMPUTER
  FURNITURE
  VEHICLE
  EQUIPMENT
  OTHER
}

enum AssetStatus {
  ACTIVE
  MAINTENANCE
  DISPOSED
  LOST
}

enum NotificationType {
  INFO
  WARNING
  ERROR
  SUCCESS
}
